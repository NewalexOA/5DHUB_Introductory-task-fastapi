# Документация по тестированию сервиса сокращения URL

В этом документе описаны тесты, реализованные для сервиса сокращения URL с использованием FastAPI и pytest. Каждый тест разработан для проверки функциональности приложения, охватывая основные возможности процесса сокращения URL.

## Настройка тестирования

Для тестирования используется отдельная база данных SQLite (`test.db`), чтобы обеспечить изоляцию между тестовыми случаями. База данных создаётся и удаляется для каждой тестовой функции с помощью фикстуры, чтобы поддерживать чистое состояние.

### Фикстуры

- `client`: Эта фикстура инициализирует `AsyncClient` с экземпляром приложения `app`, обеспечивая клиент для выполнения HTTP-запросов к API.
- `setup_and_teardown`: Эта фикстура создаёт таблицы базы данных перед каждым тестом и удаляет их после завершения теста. Также она проверяет наличие таблиц в базе данных перед запуском тестов.

## Тестовые случаи

### 1. `test_create_short_url`

- **Описание**: Тестирует создание короткого URL.
- **Входные данные**: Валидный URL (`"https://example.com"`).
- **Ожидаемый результат**:
  - Код ответа HTTP 201.
  - В ответе содержится ключ `short_url`.
  - `short_url` должен соответствовать ожидаемому формату, начинаться с базового URL и иметь длину 8 символов для короткого идентификатора.

### 2. `test_redirect_to_original_url`

- **Описание**: Тестирует перенаправление с короткого URL на оригинальный.
- **Входные данные**: Валидный URL (`"https://example.com"`), который сначала сокращается.
- **Ожидаемый результат**:
  - Код ответа HTTP 307 для перенаправления.
  - Заголовок `Location` в ответе должен указывать на оригинальный URL.

### 3. `test_database_entry_created`

- **Описание**: Тестирует прямое создание записи в базе данных.
- **Входные данные**: Прямое добавление новой записи URL с известным `short_id`.
- **Ожидаемый результат**:
  - Запись должна быть доступна в базе данных, что подтверждает её корректное создание.

### 4. `test_database_entry_not_found`

- **Описание**: Тестирует сценарий, когда запись в базе данных не найдена.
- **Входные данные**: Запрос к базе данных с несуществующим `short_id`.
- **Ожидаемый результат**:
  - Запрос должен вернуть `None`, подтверждая, что запись не существует.

### 5. `test_short_id_collision`

- **Описание**: Тестирует обработку коллизий коротких идентификаторов с использованием фиктивной функции генерации ID.
- **Входные данные**: Симулируются два запроса, которые могут генерировать один и тот же короткий идентификатор с помощью списка фиксированных ID.
- **Ожидаемый результат**:
  - Оба запроса должны привести к созданию уникальных коротких идентификаторов, обеспечивая уникальность записей.

### 6. `test_integrity_error_on_collision`

- **Описание**: Тестирует обработку `IntegrityError` при попытке добавить дублирующий короткий идентификатор.
- **Входные данные**: Попытка добавить два URL с одинаковым коротким идентификатором с использованием фиктивной функции генерации.
- **Ожидаемый результат**:
  - Приложение должно корректно обрабатывать `IntegrityError` и генерировать уникальный короткий идентификатор для следующего запроса.

## Новые тестовые случаи

### 7. `test_redirect_nonexistent_url`

- **Описание**: Тестирует перенаправление для несуществующего короткого URL.
- **Входные данные**: Короткий URL, который не существует (`"/nonexistent"`).
- **Ожидаемый результат**:
  - Код ответа HTTP 404.
  - Ответ содержит сообщение о том, что URL не найден.

### 8. `test_invalid_url_format`

- **Описание**: Тестирует обработку некорректного формата URL.
- **Входные данные**: Некорректный URL (`"not_a_valid_url"`).
- **Ожидаемый результат**:
  - Код ответа HTTP 422, указывающий на ошибку валидации.

## Заключение

Эти тесты гарантируют корректную работу сервиса сокращения URL, обрабатывая как обычные, так и пограничные случаи. Они покрывают критическую функциональность сокращения и перенаправления URL, а также обработку ошибок, связанных с целостностью базы данных и валидацией URL. Фикстуры обеспечивают изоляцию тестов и чистое состояние базы данных для каждого тестового случая.
