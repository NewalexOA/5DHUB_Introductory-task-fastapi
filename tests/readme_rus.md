# Документация тестов сервиса сокращения URL

Этот документ описывает тесты, реализованные для сервиса сокращения URL с использованием FastAPI и pytest. Каждый тест предназначен для обеспечения функциональности приложения, охватывая основные функции процесса сокращения URL.

## Настройка тестов

Тесты используют SQLite базу данных в памяти, чтобы обеспечить изоляцию между тестами. База данных создается и удаляется для каждой тестовой функции с помощью фикстуры.

### Фикстуры

- `setup_and_teardown`: Эта фикстура создает таблицы базы данных перед каждым тестом и удаляет их после, чтобы поддерживать чистое состояние.

## Тестовые случаи

### 1. `test_create_short_url`

- **Описание**: Тестирует создание короткого URL.
- **Входные данные**: Валидный URL (`"https://example.com"`).
- **Ожидаемый результат**: 
  - HTTP статус код 201.
  - Ответ содержит ключ `short_url`.
  - `short_url` должен соответствовать ожидаемому формату, начинаться с базового URL и иметь длину 8 символов для короткого ID.

### 2. `test_redirect_to_original_url`

- **Описание**: Тестирует перенаправление с короткого URL на оригинальный URL.
- **Входные данные**: Валидный URL (`"https://example.com"`), который сначала сокращается.
- **Ожидаемый результат**:
  - HTTP статус код 307 для перенаправления.
  - Заголовок `Location` в ответе должен указывать на оригинальный URL.

### 3. `test_redirect_nonexistent_url`

- **Описание**: Тестирует перенаправление для несуществующего короткого URL.
- **Входные данные**: Короткий URL, который не существует (`"/nonexistent"`).
- **Ожидаемый результат**:
  - HTTP статус код 404.
  - Ответ содержит сообщение, указывающее, что URL не найден.

### 4. `test_invalid_url_format`

- **Описание**: Тестирует обработку некорректного формата URL.
- **Входные данные**: Некорректный URL (`"not_a_valid_url"`).
- **Ожидаемый результат**:
  - HTTP статус код 422, указывающий на ошибку валидации.

### 5. `test_database_entry_created`

- **Описание**: Тестирует прямое создание записи в базе данных.
- **Входные данные**: Прямое добавление новой записи URL с известным `short_id`.
- **Ожидаемый результат**:
  - Запись должна быть доступна в базе данных, подтверждая, что она была создана корректно.

### 6. `test_database_entry_not_found`

- **Описание**: Тестирует сценарий, когда запись в базе данных не найдена.
- **Входные данные**: Запрос к базе данных для несуществующего `short_id`.
- **Ожидаемый результат**:
  - Запрос должен вернуть `None`, подтверждая, что запись не существует.

### 7. `test_short_id_collision`

- **Описание**: Тестирует обработку коллизий коротких ID.
- **Входные данные**: Симулирует два запроса, которые могут сгенерировать одинаковый короткий ID.
- **Ожидаемый результат**:
  - Оба запроса должны привести к генерации различных коротких ID, обеспечивая уникальность записей.

### 8. `test_integrity_error_on_collision`

- **Описание**: Тестирует обработку `IntegrityError` при попытке добавить дубликат короткого ID.
- **Входные данные**: Попытка добавить два URL с одинаковым сгенерированным коротким ID.
- **Ожидаемый результат**:
  - Приложение должно обработать `IntegrityError` и сгенерировать уникальный короткий ID для второго запроса.

## Заключение

Эти тесты обеспечивают корректную работу сервиса сокращения URL, обрабатывая как нормальные, так и крайние случаи. Они охватывают ключевую функциональность сокращения URL и перенаправления, а также обработку ошибок, связанных с целостностью базы данных и валидацией URL.
